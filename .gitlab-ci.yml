# Copyright (C) 2022 Magenta ApS, http://magenta.dk.
# Contact: info@magenta.dk.
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.


stages:
  - build

variables:
  ISO_SHA: ${CI_COMMIT_SHORT_SHA}
  BUILD_IMAGE_VERSION: "22.04"
  ISO_NAME: "ubuntu-22.04.2-desktop-amd64.iso"

# Build stage
#############

# Note: The caching of the source image does, unfortunately not seem to work yet?

Build ISO image:
  stage: build
  needs: []
  when: manual
  image: ubuntu:${BUILD_IMAGE_VERSION}
  before_script:
    - apt-get -y update > /dev/null
    - apt-get -y install apt-utils fdisk figlet rsync sudo wget > /dev/null
    - cd image
    - wget --progress=bar:force --continue http://releases.ubuntu.com/${BUILD_IMAGE_VERSION}/${ISO_NAME}
  script:
    - ./build_os2borgerpc_image.sh ./${ISO_NAME} ${ISO_SHA}
  cache:
    paths:
      - image/${ISO_NAME}
  artifacts:
    paths:
      - image/${ISO_SHA}.iso
    expire_in: 1 week

# Like above, but call build_os2borgerpc_image.sh with the optional argument enabling multilang support
Build Multilang ISO image:
  stage: build
  needs: []
  when: manual
  image: ubuntu:${BUILD_IMAGE_VERSION}
  before_script:
    - apt-get -y update > /dev/null
    - apt-get -y install apt-utils fdisk figlet rsync sudo wget > /dev/null
    - cd image
    - wget --progress=bar:force --continue http://releases.ubuntu.com/${BUILD_IMAGE_VERSION}/${ISO_NAME}
  script:
    - ./build_os2borgerpc_image.sh --lang-all ./${ISO_NAME} ${ISO_SHA}
  cache:
    paths:
      - image/${ISO_NAME}
  artifacts:
    paths:
      - image/${ISO_SHA}.iso
    expire_in: 1 week
